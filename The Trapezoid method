# Трапеции
import math
import time


def f(x):
    if x == 0:
        return 0
    # Вычисление R2
    numerator_r2 = -x**2 + x + 5
    r2 = math.asin(1/numerator_r2)

    # Вычисление R1
    numerator_r1 = 4 * x**3 + 2 * x**2 - 4 * x + 2
    S = math.sqrt(2)
    r1 = numerator_r1 ** S
    return r1 + r2 - 5.0


def integrate_optimized(a, b, n, prev_values=None):
    h = (b - a) / n
    total = (f(a) + f(b)) / 2

    if prev_values is None:
        # Первый вызов - вычисляем все точки
        values = []
        for i in range(1, n):
            x = a + i * h
            values.append(f(x))
        total += sum(values)
        return total * h, values
    else:
        # Последующие вызовы - используем старые точки и добавляем новые
        new_values = []
        for i in range(1, n, 2):  # Только новые нечетные точки
            x = a + i * h
            new_values.append(f(x))

        # Объединяем старые и новые значения
        all_values = []
        j = 0
        k = 0
        for i in range(1, n):
            if i % 2 == 1:  # Новая точка
                all_values.append(new_values[j])
                j += 1
            else:  # Старая точка (из предыдущей итерации)
                all_values.append(prev_values[k])
                k += 1

        total += sum(all_values)
        return total * h, all_values


def calc():
    a = -1.0
    b = 1.0
    eps = 0.001
    k = 2
    fctr = (2**k - 1)

    n = 10
    start_time = time.time()

    # Первое вычисление
    I_prev, prev_values = integrate_optimized(a, b, n)
    n *= 2
    # Второе вычисление с использованием предыдущих значений
    I_cur, cur_values = integrate_optimized(a, b, n, prev_values)
    R = abs(I_cur - I_prev) / fctr

    while R >= eps:
        n *= 2
        I_prev = I_cur
        prev_values = cur_values
        I_cur, cur_values = integrate_optimized(a, b, n, prev_values)
        R = abs(I_cur - I_prev) / fctr

    end_time = time.time()

    print(f"Приближенное значение интеграла: {I_cur + (I_cur-I_prev)/(2**k - 1):.6f}")
    print(f"Шаг интегрирования: {(b - a)/n:.6f}")
    print(f"Число разбиений: {n}")
    print(f"Время работы программы: {end_time - start_time:.8f} секунд")


calc()
